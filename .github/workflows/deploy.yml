name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build-and-deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          
      - name: Build static site from Django templates
        run: |
          # Create output directory
          mkdir -p docs
          
          # Copy static files if they exist
          if [ -d "static" ]; then
            cp -r static docs/
          else
            echo "Static directory not found, creating empty one"
            mkdir -p docs/static
          fi
          
          # Copy media files if they exist
          if [ -d "media" ]; then
            cp -r media docs/
          fi
          
          # Copy demo images if they exist
          if [ -d "HealthCare Patient and Doctor Demo" ]; then
            cp -r "HealthCare Patient and Doctor Demo" docs/
          fi
          
          # List current directory contents for debugging
          echo "Current directory contents:"
          ls -la
          echo "Templates directory contents:"
          ls -la templates/ || echo "Templates directory not found"
          
          # Convert Django templates to static HTML with proper template inheritance
          python3 << 'EOF'
          import os
          import re
          import shutil
          from pathlib import Path
          
          def load_base_template():
              """Load and process the base template"""
              base_path = 'templates/base.html'
              if os.path.exists(base_path):
                  with open(base_path, 'r', encoding='utf-8') as f:
                      base_content = f.read()
                  
                  # Process base template
                  base_content = re.sub(r'{%\s*load\s+[^%]+%}', '', base_content)
                  base_content = re.sub(r'{%\s*static\s+[\'"]([^\'"]+)[\'"]\s*%}', r'static/\1', base_content)
                  
                  # Replace block content placeholders
                  base_content = re.sub(r'{%\s*block\s+title\s*%}[^{]*{%\s*endblock\s*%}', 'VB Healthcare Management System', base_content)
                  base_content = re.sub(r'{%\s*block\s+content\s*%}[^{]*{%\s*endblock\s*%}', '<!-- CONTENT_PLACEHOLDER -->', base_content)
                  base_content = re.sub(r'{%\s*block\s+extra_css\s*%}[^{]*{%\s*endblock\s*%}', '', base_content)
                  base_content = re.sub(r'{%\s*block\s+extra_js\s*%}[^{]*{%\s*endblock\s*%}', '', base_content)
                  
                  # Clean up any remaining template syntax
                  base_content = re.sub(r'{%[^%]*%}', '', base_content)
                  base_content = re.sub(r'{{[^}]*user[^}]*}}', 'Demo User', base_content)
                  base_content = re.sub(r'{{[^}]*}}', '', base_content)
                  
                  return base_content
              return None
          
          def convert_template_with_inheritance(template_path, output_path, base_template):
              """Convert Django template handling inheritance properly"""
              try:
                  with open(template_path, 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  # Check if this template extends base
                  if '{% extends' in content:
                      # Extract content from blocks
                      title_match = re.search(r'{%\s*block\s+title\s*%}(.*?){%\s*endblock\s*%}', content, re.DOTALL)
                      content_match = re.search(r'{%\s*block\s+content\s*%}(.*?){%\s*endblock\s*%}', content, re.DOTALL)
                      
                      title = title_match.group(1).strip() if title_match else 'VB Healthcare'
                      page_content = content_match.group(1).strip() if content_match else content
                      
                      # Replace title in base template
                      final_content = base_template.replace('VB Healthcare Management System', title)
                      # Replace content placeholder
                      final_content = final_content.replace('<!-- CONTENT_PLACEHOLDER -->', page_content)
                  else:
                      # Standalone template
                      final_content = content
                  
                  # Process the final content
                  final_content = re.sub(r'{%\s*load\s+[^%]+%}', '', final_content)
                  final_content = re.sub(r'{%\s*extends\s+[^%]+%}', '', final_content)
                  final_content = re.sub(r'{%\s*static\s+[\'"]([^\'"]+)[\'"]\s*%}', r'static/\1', final_content)
                  
                  # Replace URL patterns with static links
                  url_replacements = {
                      r'{%\s*url\s+[\'"]home[\'"]\s*%}': 'index.html',
                      r'{%\s*url\s+[\'"]about[\'"]\s*%}': 'about.html',
                      r'{%\s*url\s+[\'"]privacy_policy[\'"]\s*%}': 'privacy_policy.html',
                      r'{%\s*url\s+[\'"]terms_of_service[\'"]\s*%}': 'terms_of_service.html',
                      r'{%\s*url\s+[\'"]accounts:login[\'"]\s*%}': 'accounts-login.html',
                      r'{%\s*url\s+[\'"]accounts:register[\'"]\s*%}': 'accounts-register.html',
                      r'{%\s*url\s+[\'"]accounts:profile[\'"]\s*%}': 'accounts-profile.html',
                      r'{%\s*url\s+[\'"]accounts:profile_update[\'"]\s*%}': 'accounts-profile_update.html',
                      r'{%\s*url\s+[\'"]patients:dashboard[\'"]\s*%}': 'patients-dashboard.html',
                      r'{%\s*url\s+[\'"]patients:appointments[\'"]\s*%}': 'patients-appointments.html',
                      r'{%\s*url\s+[\'"]patients:medical_records[\'"]\s*%}': 'patients-medical_records.html',
                      r'{%\s*url\s+[\'"]doctors:dashboard[\'"]\s*%}': 'doctors-dashboard.html',
                      r'{%\s*url\s+[\'"]doctors:appointments[\'"]\s*%}': 'doctors-appointments.html',
                      r'{%\s*url\s+[\'"]doctors:patients[\'"]\s*%}': 'doctors-patients.html',
                      r'{%\s*url\s+[\'"]appointments:book[\'"]\s*%}': 'appointments-book.html',
                      r'{%\s*url\s+[\'"]appointments:list[\'"]\s*%}': 'appointments-list.html',
                      r'{%\s*url\s+[\'"]medical_records:list[\'"]\s*%}': 'medical_records-list.html',
                  }
                  
                  for pattern, replacement in url_replacements.items():
                      final_content = re.sub(pattern, replacement, final_content)
                  
                  # Remove Django template syntax
                  final_content = re.sub(r'{%\s*csrf_token\s*%}', '', final_content)
                  final_content = re.sub(r'{%\s*if\s+[^%]+%}', '', final_content)
                  final_content = re.sub(r'{%\s*endif\s*%}', '', final_content)
                  final_content = re.sub(r'{%\s*for\s+[^%]+%}', '<!-- Sample data loop -->', final_content)
                  final_content = re.sub(r'{%\s*empty\s*%}', '<!-- No data available -->', final_content)
                  final_content = re.sub(r'{%\s*endfor\s*%}', '<!-- End sample data -->', final_content)
                  final_content = re.sub(r'{%\s*block\s+[^%]+%}', '', final_content)
                  final_content = re.sub(r'{%\s*endblock\s*%}', '', final_content)
                  final_content = re.sub(r'{%\s*comment\s*%}.*?{%\s*endcomment\s*%}', '', final_content, flags=re.DOTALL)
                  
                  # Replace template variables with realistic demo data
                  final_content = re.sub(r'{{[^}]*user\.first_name[^}]*}}', 'John', final_content)
                  final_content = re.sub(r'{{[^}]*user\.last_name[^}]*}}', 'Patient', final_content)
                  final_content = re.sub(r'{{[^}]*user\.email[^}]*}}', 'john.patient@demo.com', final_content)
                  final_content = re.sub(r'{{[^}]*user\.username[^}]*}}', 'johnpatient', final_content)
                  final_content = re.sub(r'{{[^}]*user\.get_full_name[^}]*}}', 'John Patient', final_content)
                  final_content = re.sub(r'{{[^}]*user[^}]*}}', 'Demo User', final_content)
                  final_content = re.sub(r'{{[^}]*patient\.name[^}]*}}', 'John Patient', final_content)
                  final_content = re.sub(r'{{[^}]*doctor\.name[^}]*}}', 'Dr. Sarah Smith', final_content)
                  final_content = re.sub(r'{{[^}]*appointment\.date[^}]*}}', '2025-09-25', final_content)
                  final_content = re.sub(r'{{[^}]*appointment\.time[^}]*}}', '10:00 AM', final_content)
                  final_content = re.sub(r'{{[^}]*total_appointments[^}]*}}', '12', final_content)
                  final_content = re.sub(r'{{[^}]*pending_appointments[^}]*}}', '3', final_content)
                  final_content = re.sub(r'{{[^}]*completed_appointments[^}]*}}', '8', final_content)
                  final_content = re.sub(r'{{[^}]*total_patients[^}]*}}', '25', final_content)
                  final_content = re.sub(r'{{[^}]*phone[^}]*}}', '+1 (555) 123-4567', final_content)
                  final_content = re.sub(r'{{[^}]*date[^}]*}}', '2025-09-24', final_content)
                  final_content = re.sub(r'{{[^}]*count[^}]*}}', '5', final_content)
                  final_content = re.sub(r'{{[^}]*}}', '', final_content)  # Remove any remaining variables
                  
                  # Create output directory
                  os.makedirs(os.path.dirname(output_path), exist_ok=True)
                  
                  # Write the final content
                  with open(output_path, 'w', encoding='utf-8') as f:
                      f.write(final_content)
                  
                  print(f"✓ Converted: {template_path} -> {output_path}")
                  return True
                  
              except Exception as e:
                  print(f"✗ Error converting {template_path}: {e}")
                  return False
          
          # Load base template
          base_template = load_base_template()
          if not base_template:
              print("Warning: base.html not found, using simple HTML structure")
              base_template = """<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>VB Healthcare</title>
              <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
          </head>
          <body>
          <!-- CONTENT_PLACEHOLDER -->
          <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
          </body>
          </html>"""
          
          # Convert all templates
          converted_count = 0
          
          if os.path.exists('templates'):
              for root, dirs, files in os.walk('templates'):
                  for file in files:
                      if file.endswith('.html') and file != 'base.html' and file != 'base_simple.html':
                          template_path = os.path.join(root, file)
                          
                          # Create meaningful output filename
                          relative_path = os.path.relpath(template_path, 'templates')
                          
                          if file == 'home.html':
                              output_file = 'index.html'
                          else:
                              # Convert subdirectory/filename.html to subdirectory-filename.html
                              output_file = relative_path.replace('/', '-').replace('\\', '-')
                          
                          output_path = os.path.join('docs', output_file)
                          
                          if convert_template_with_inheritance(template_path, output_path, base_template):
                              converted_count += 1
          
          print(f"\n🎉 Successfully converted {converted_count} templates to static HTML files!")
          
          # Create a simple index page if home.html doesn't exist
          if not os.path.exists('docs/index.html'):
              with open('docs/index.html', 'w') as f:
                  f.write('''<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>VB Healthcare Management System</title>
              <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
          </head>
          <body>
              <div class="container mt-5">
                  <div class="text-center">
                      <h1><i class="fas fa-shield-alt text-primary"></i> VB Healthcare Management System</h1>
                      <p class="lead">Welcome to the Healthcare Management Demo</p>
                      <div class="row mt-4">
                          <div class="col-md-6 mb-3">
                              <div class="card">
                                  <div class="card-body">
                                      <h5 class="card-title"><i class="fas fa-user-injured"></i> Patient Portal</h5>
                                      <p class="card-text">Access patient dashboard and services</p>
                                      <a href="patients-dashboard.html" class="btn btn-primary">View Dashboard</a>
                                  </div>
                              </div>
                          </div>
                          <div class="col-md-6 mb-3">
                              <div class="card">
                                  <div class="card-body">
                                      <h5 class="card-title"><i class="fas fa-user-md"></i> Doctor Portal</h5>
                                      <p class="card-text">Access doctor dashboard and tools</p>
                                      <a href="doctors-dashboard.html" class="btn btn-success">View Dashboard</a>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
              </div>
          </body>
          </html>''')
              print("✓ Created default index.html")
          
          EOF
          
          # Create an enhanced navigation page listing all available pages
          python3 << 'EOF'
          import os
          import glob
          
          html_files = glob.glob('docs/*.html')
          html_files = [f for f in html_files if not f.endswith('navigation.html')]
          
          # Categorize pages for better organization
          page_categories = {
              'Main Pages': ['index.html', 'about.html', 'privacy_policy.html', 'terms_of_service.html'],
              'Patient Portal': [f for f in html_files if 'patients-' in os.path.basename(f)],
              'Doctor Portal': [f for f in html_files if 'doctors-' in os.path.basename(f)],
              'Appointments': [f for f in html_files if 'appointment' in os.path.basename(f)],
              'Medical Records': [f for f in html_files if 'medical' in os.path.basename(f)],
              'User Accounts': [f for f in html_files if 'accounts-' in os.path.basename(f)],
              'Other Pages': []
          }
          
          # Collect uncategorized pages
          categorized_files = set()
          for category_files in page_categories.values():
              categorized_files.update([os.path.basename(f) for f in category_files])
          
          for html_file in html_files:
              filename = os.path.basename(html_file)
              if filename not in categorized_files and filename not in page_categories['Main Pages']:
                  page_categories['Other Pages'].append(html_file)
          
          nav_content = '''<!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>VB Healthcare - All Pages</title>
              <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
              <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
              <style>
                  :root {
                      --vb-primary: #2c5aa0;
                      --vb-secondary: #4a90e2;
                  }
                  body { background-color: #f8f9fa; }
                  .navbar-brand { color: var(--vb-primary) !important; font-weight: bold; }
                  .category-card { border-left: 4px solid var(--vb-primary); }
                  .page-card { transition: transform 0.3s ease; }
                  .page-card:hover { transform: translateY(-5px); }
              </style>
          </head>
          <body>
              <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
                  <div class="container">
                      <a class="navbar-brand" href="index.html">
                          <i class="fas fa-shield-alt text-success"></i> VB HealthCare
                      </a>
                      <div class="navbar-nav ms-auto">
                          <a class="nav-link" href="index.html">Home</a>
                          <a class="nav-link" href="about.html">About</a>
                      </div>
                  </div>
              </nav>
          
              <div class="container">
                  <div class="text-center mb-5">
                      <h1><i class="fas fa-sitemap text-primary"></i> Healthcare Management System Demo</h1>
                      <p class="lead">Explore all pages of the VB Healthcare Management System</p>
                      <div class="alert alert-info">
                          <i class="fas fa-info-circle"></i> 
                          <strong>Demo Note:</strong> All pages are accessible without login for demonstration purposes.
                          In the full system, authentication would be required for patient and doctor portals.
                      </div>
                  </div>
          '''
          
          # Icon mapping for different page types
          icon_map = {
              'index': 'fas fa-home',
              'about': 'fas fa-info-circle',
              'privacy': 'fas fa-shield-alt',
              'terms': 'fas fa-file-contract',
              'patients-dashboard': 'fas fa-tachometer-alt',
              'patients-appointments': 'fas fa-calendar-check',
              'patients-medical': 'fas fa-file-medical-alt',
              'doctors-dashboard': 'fas fa-stethoscope',
              'doctors-appointments': 'fas fa-calendar-alt',
              'doctors-patients': 'fas fa-users',
              'accounts-login': 'fas fa-sign-in-alt',
              'accounts-register': 'fas fa-user-plus',
              'accounts-profile': 'fas fa-user-circle',
              'appointment': 'fas fa-calendar',
              'medical': 'fas fa-file-medical'
          }
          
          def get_icon(filename):
              for key, icon in icon_map.items():
                  if key in filename.lower():
                      return icon
              return 'fas fa-file-alt'
          
          def get_display_name(filename):
              name = filename.replace('.html', '').replace('-', ' ')
              # Special cases for better naming
              if 'patients-dashboard' in filename:
                  return 'Patient Dashboard'
              elif 'doctors-dashboard' in filename:
                  return 'Doctor Dashboard'
              elif 'accounts-' in filename:
                  return name.replace('accounts ', '').title()
              return name.title()
          
          for category, files in page_categories.items():
              if files:  # Only show categories that have files
                  nav_content += f'''
                  <div class="row mb-4">
                      <div class="col-12">
                          <div class="card category-card">
                              <div class="card-header bg-light">
                                  <h4 class="mb-0 text-primary">{category}</h4>
                              </div>
                              <div class="card-body">
                                  <div class="row">
                  '''
                  
                  for html_file in sorted(files):
                      filename = os.path.basename(html_file)
                      display_name = get_display_name(filename)
                      icon = get_icon(filename)
                      
                      nav_content += f'''
                                      <div class="col-md-4 col-lg-3 mb-3">
                                          <div class="card page-card h-100">
                                              <div class="card-body text-center">
                                                  <i class="{icon} fa-2x text-primary mb-2"></i>
                                                  <h6 class="card-title">{display_name}</h6>
                                                  <a href="{filename}" class="btn btn-primary btn-sm">
                                                      <i class="fas fa-eye"></i> View Page
                                                  </a>
                                              </div>
                                          </div>
                                      </div>
                      '''
                  
                  nav_content += '''
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
                  '''
          
          nav_content += '''
              </div>
              
              <footer class="bg-dark text-white text-center py-4 mt-5">
                  <div class="container">
                      <p class="mb-0">© 2025 Venkat Buthuru. All rights reserved.</p>
                      <p class="mb-0">VB Healthcare Management System - Demo Version</p>
                  </div>
              </footer>
          </body>
          </html>
          '''
          
          with open('docs/navigation.html', 'w') as f:
              f.write(nav_content)
          
          print("✓ Created enhanced navigation.html with categorized page links")
          EOF
          
          # Create a README for the docs folder
          cat > docs/README.md << 'MDEOF'
          # VB Healthcare Management System - Static Demo
          
          This is a static version of the Healthcare Management System deployed on GitHub Pages.
          All Django templates have been converted to static HTML for demonstration purposes.
          
          ## Available Pages
          
          - **Home**: index.html - Main landing page
          - **Navigation**: navigation.html - Links to all pages
          - **Patient Dashboard**: patients-dashboard.html - Patient interface
          - **Doctor Dashboard**: doctors-dashboard.html - Doctor interface
          - **Appointments**: appointments.html - Appointment management
          - **Medical Records**: medical-records.html - Patient records
          - **About**: about.html - Company information
          
          All pages are accessible without authentication for demo purposes.
          
          ## Live Demo
          
          Visit: https://buthuruvenkatareddy.github.io/HealthCare_Patient_Management_System/
          
          © 2025 Venkat Buthuru. All rights reserved.
          MDEOF
          
          echo "Build completed! Static site ready in docs/ directory"
          echo "Files created:"
          ls -la docs/ | head -20
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './docs'
          
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4