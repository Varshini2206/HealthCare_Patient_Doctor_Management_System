{% extends 'base.html' %}

{% block title %}My Medical Records - HealthCare Management System{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-file-medical"></i> My Medical Records</h1>
    <div>
        <button class="btn btn-outline-primary me-2" data-bs-toggle="modal" data-bs-target="#exportModal">
            <i class="fas fa-download"></i> Export Records
        </button>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#requestModal">
            <i class="fas fa-plus"></i> Request Records
        </button>
    </div>
</div>

<!-- Quick Stats -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center border-primary">
            <div class="card-body">
                <h3 class="text-primary">{{ total_records|default:"0" }}</h3>
                <p class="mb-0">Total Records</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-success">
            <div class="card-body">
                <h3 class="text-success">{{ recent_tests|default:"0" }}</h3>
                <p class="mb-0">Recent Tests</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-warning">
            <div class="card-body">
                <h3 class="text-warning">{{ active_prescriptions|default:"0" }}</h3>
                <p class="mb-0">Active Prescriptions</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center border-info">
            <div class="card-body">
                <h3 class="text-info">{{ total_appointments|default:"0" }}</h3>
                <p class="mb-0">Appointments</p>
            </div>
        </div>
    </div>
</div>

<!-- Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="recordTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
            <i class="fas fa-chart-line"></i> Overview
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="visits-tab" data-bs-toggle="tab" data-bs-target="#visits" type="button" role="tab">
            <i class="fas fa-calendar-check"></i> Visit History
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="tests-tab" data-bs-toggle="tab" data-bs-target="#tests" type="button" role="tab">
            <i class="fas fa-vial"></i> Lab Tests
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="prescriptions-tab" data-bs-toggle="tab" data-bs-target="#prescriptions" type="button" role="tab">
            <i class="fas fa-pills"></i> Prescriptions
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab">
            <i class="fas fa-file-alt"></i> Documents
        </button>
    </li>
</ul>

<div class="tab-content" id="recordTabContent">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel">
        <div class="row">
            <div class="col-md-8">
                <!-- Health Timeline -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-timeline"></i> Health Timeline</h5>
                    </div>
                    <div class="card-body">
                        <div class="timeline">
                            {% for record in medical_records|slice:":3" %}
                            <div class="timeline-item">
                                <div class="timeline-marker bg-{% if record.diagnosis == 'Healthy' %}success{% elif 'Diabetes' in record.diagnosis %}warning{% else %}info{% endif %}"></div>
                                <div class="timeline-content">
                                    <h6>{{ record.type }}</h6>
                                    <p class="text-muted mb-1">{{ record.date|date:"M d, Y" }}</p>
                                    <p class="mb-0">{{ record.notes|truncatewords:12 }}</p>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-clock"></i> Recent Activity</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group list-group-flush">
                            {% for test in lab_results|slice:":2" %}
                            <div class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <h6 class="mb-1">{{ test.test_name }} Available</h6>
                                    <p class="mb-0 text-muted">{{ test.results }}</p>
                                </div>
                                <small class="text-muted">{{ test.date|date:"M d" }}</small>
                            </div>
                            {% endfor %}
                            
                            {% for prescription in prescriptions|slice:":1" %}
                                {% if prescription.status == 'Active' %}
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1">Prescription: {{ prescription.medication }}</h6>
                                        <p class="mb-0 text-muted">{{ prescription.dosage }} {{ prescription.frequency }} prescribed</p>
                                    </div>
                                    <small class="text-muted">{{ prescription.prescribed_date|date:"M d" }}</small>
                                </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <!-- Current Health Status -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-heartbeat"></i> Current Health Status</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <div class="d-flex justify-content-between">
                                <span>Overall Health</span>
                                <span class="badge bg-success">Excellent</span>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Blood Pressure</label>
                            <div class="progress">
                                <div class="progress-bar bg-success" style="width: 75%">120/80</div>
                            </div>
                            <small class="text-muted">Normal range</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Cholesterol</label>
                            <div class="progress">
                                <div class="progress-bar bg-warning" style="width: 60%">185 mg/dL</div>
                            </div>
                            <small class="text-muted">Slightly elevated</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">BMI</label>
                            <div class="progress">
                                <div class="progress-bar bg-success" style="width: 70%">24.5</div>
                            </div>
                            <small class="text-muted">Normal weight</small>
                        </div>
                    </div>
                </div>

                <!-- Allergies & Conditions -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-exclamation-triangle"></i> Allergies & Conditions</h5>
                    </div>
                    <div class="card-body">
                        <h6>Known Allergies</h6>
                        <div class="mb-3">
                            <span class="badge bg-danger me-2">Penicillin</span>
                            <span class="badge bg-danger">Peanuts</span>
                        </div>
                        
                        <h6>Current Conditions</h6>
                        <div class="mb-3">
                            <span class="badge bg-info me-2">Hypertension</span>
                            <span class="badge bg-warning">Type 2 Diabetes</span>
                        </div>
                    </div>
                </div>

                <!-- Emergency Contact -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-phone"></i> Emergency Contact</h5>
                    </div>
                    <div class="card-body">
                        <p><strong>Jane Smith</strong><br>
                        Spouse<br>
                        +1 (555) 987-6543</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Visit History Tab -->
    <div class="tab-pane fade" id="visits" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Doctor</th>
                                <th>Visit Type</th>
                                <th>Diagnosis</th>
                                <th>Vitals</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if medical_records %}
                                {% for record in medical_records %}
                                <tr>
                                    <td>{{ record.date|date:"M d, Y" }}</td>
                                    <td>{{ record.doctor }}</td>
                                    <td>
                                        <span class="badge bg-{% if record.type == 'Annual Check-up' %}primary{% elif record.type == 'Follow-up' %}warning{% elif record.type == 'Specialist Consultation' %}info{% else %}secondary{% endif %}">
                                            {{ record.type }}
                                        </span>
                                    </td>
                                    <td>{{ record.diagnosis }}</td>
                                    <td>{{ record.vitals|truncatewords:4 }}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewVisitDetails('{{ record.date }}', '{{ record.doctor }}')">
                                            <i class="fas fa-eye"></i> View Details
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <i class="fas fa-calendar-times fa-2x mb-2"></i><br>
                                        No visit history found.
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Lab Tests Tab -->
    <div class="tab-pane fade" id="tests" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Test Name</th>
                                <th>Date</th>
                                <th>Lab</th>
                                <th>Result</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if lab_results %}
                                {% for result in lab_results %}
                                <tr>
                                    <td>{{ result.test_name }}</td>
                                    <td>{{ result.date }}</td>
                                    <td>{{ result.lab }}</td>
                                    <td>{{ result.results }}</td>
                                    <td>
                                        <span class="badge bg-{% if result.status == 'Completed' %}success{% else %}warning{% endif %}">
                                            {{ result.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary" onclick="viewLabDetails('{{ result.test_name }}', '{{ result.date }}')">
                                            <i class="fas fa-eye"></i> View Details
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <i class="fas fa-flask fa-2x mb-2"></i><br>
                                        No lab test results found.
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Prescriptions Tab -->
    <div class="tab-pane fade" id="prescriptions" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Medication</th>
                                <th>Dosage</th>
                                <th>Prescribed Date</th>
                                <th>Refills</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if prescriptions %}
                                {% for prescription in prescriptions %}
                                <tr>
                                    <td>{{ prescription.medication }}</td>
                                    <td>{{ prescription.dosage }} {{ prescription.frequency }}</td>
                                    <td>{{ prescription.prescribed_date }}</td>
                                    <td>{{ prescription.refills }} remaining</td>
                                    <td>
                                        <span class="badge bg-{% if prescription.status == 'Active' %}success{% elif prescription.status == 'Completed' %}secondary{% else %}danger{% endif %}">
                                            {{ prescription.status }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if prescription.status == 'Active' and prescription.refills > 0 %}
                                        <button class="btn btn-sm btn-outline-warning" onclick="requestRefill('{{ prescription.medication }}')">
                                            <i class="fas fa-redo"></i> Refill
                                        </button>
                                        {% elif prescription.status == 'Active' %}
                                        <button class="btn btn-sm btn-outline-primary" onclick="contactDoctor('{{ prescription.medication }}')">
                                            <i class="fas fa-phone"></i> Contact Doctor
                                        </button>
                                        {% else %}
                                        <button class="btn btn-sm btn-outline-info" onclick="viewPrescriptionDetails('{{ prescription.medication }}')">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        <i class="fas fa-pills fa-2x mb-2"></i><br>
                                        No prescriptions found.
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Documents Tab -->
    <div class="tab-pane fade" id="documents" role="tabpanel">
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5><i class="fas fa-folder-open"></i> Documents</h5>
                    <div>
                        <button class="btn btn-outline-info btn-sm me-2" onclick="testDocumentButtons()">
                            <i class="fas fa-test"></i> Test JS
                        </button>
                        <button class="btn btn-outline-primary btn-sm" onclick="uploadDocument()">
                            <i class="fas fa-upload"></i> Upload Document
                        </button>
                    </div>
                </div>
                <div class="row">
                    {% if documents %}
                        {% for document in documents %}
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body text-center">
                                    {% if document.format == 'PDF' %}
                                        <i class="fas fa-file-pdf fa-3x text-danger mb-3"></i>
                                    {% elif document.type == 'Imaging' %}
                                        <i class="fas fa-x-ray fa-3x text-info mb-3"></i>
                                    {% elif document.type == 'Medical' %}
                                        <i class="fas fa-file-medical fa-3x text-success mb-3"></i>
                                    {% elif document.type == 'Insurance' %}
                                        <i class="fas fa-id-card fa-3x text-warning mb-3"></i>
                                    {% else %}
                                        <i class="fas fa-file-alt fa-3x text-primary mb-3"></i>
                                    {% endif %}
                                    <h6>{{ document.name }}</h6>
                                    <p class="text-muted small">{{ document.date_uploaded }}</p>
                                    <p class="text-muted small">{{ document.size }}</p>
                                    <div class="d-flex gap-1 justify-content-center">
                                        <button class="btn btn-outline-primary btn-sm" onclick="viewDocument('{{ document.name }}')">
                                            <i class="fas fa-eye"></i> View
                                        </button>
                                        <button class="btn btn-outline-secondary btn-sm" onclick="downloadDocument('{{ document.name }}')">
                                            <i class="fas fa-download"></i> Download
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <div class="col-12">
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-folder-open fa-3x mb-3"></i>
                                <h5>No Documents Found</h5>
                                <p>Your medical documents will appear here once uploaded.</p>
                                <button class="btn btn-primary" onclick="uploadDocument()">
                                    <i class="fas fa-plus"></i> Upload Document
                                </button>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.timeline {
    position: relative;
    padding: 0;
    list-style: none;
}

.timeline-item {
    position: relative;
    padding-left: 30px;
    padding-bottom: 20px;
}

.timeline-item:before {
    content: '';
    position: absolute;
    left: 10px;
    top: 20px;
    bottom: -10px;
    width: 2px;
    background: #e9ecef;
}

.timeline-item:last-child:before {
    display: none;
}

.timeline-marker {
    position: absolute;
    left: 0;
    top: 0;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 3px solid #fff;
    box-shadow: 0 0 0 3px #e9ecef;
}

.timeline-content {
    margin-top: 5px;
}
</style>

<!-- Export Records Modal -->
<div class="modal fade" id="exportModal" tabindex="-1" aria-labelledby="exportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exportModalLabel">
                    <i class="fas fa-download"></i> Export Medical Records
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="exportForm" action="{% url 'patients:export_medical_records' %}" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label"><strong>Select Records to Export:</strong></label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="appointments" id="exportAppointments" checked>
                            <label class="form-check-label" for="exportAppointments">
                                Appointment History
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="medical_records" id="exportMedical" checked>
                            <label class="form-check-label" for="exportMedical">
                                Medical Records & Notes
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="prescriptions" id="exportPrescriptions" checked>
                            <label class="form-check-label" for="exportPrescriptions">
                                Prescriptions & Medications
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" value="lab_results" id="exportLabs" checked>
                            <label class="form-check-label" for="exportLabs">
                                Lab Tests & Results
                            </label>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="dateRange" class="form-label"><strong>Date Range:</strong></label>
                        <select class="form-select" name="date_range" id="dateRange">
                            <option value="all">All Records</option>
                            <option value="last_year">Last 12 Months</option>
                            <option value="last_6months">Last 6 Months</option>
                            <option value="last_3months">Last 3 Months</option>
                            <option value="custom">Custom Range</option>
                        </select>
                    </div>
                    
                    <div id="customDateRange" class="mb-3" style="display: none;">
                        <div class="row">
                            <div class="col-6">
                                <label for="startDate" class="form-label">From Date:</label>
                                <input type="date" class="form-control" name="start_date" id="startDate">
                            </div>
                            <div class="col-6">
                                <label for="endDate" class="form-label">To Date:</label>
                                <input type="date" class="form-control" name="end_date" id="endDate">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="exportFormat" class="form-label"><strong>Export Format:</strong></label>
                        <select class="form-select" name="format" id="exportFormat">
                            <option value="pdf">PDF Document</option>
                            <option value="excel">Excel Spreadsheet</option>
                            <option value="csv">CSV File</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="exportRecords()">
                    <i class="fas fa-download"></i> Export Records
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Request Records Modal -->
<div class="modal fade" id="requestModal" tabindex="-1" aria-labelledby="requestModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="requestModalLabel">
                    <i class="fas fa-plus"></i> Request Medical Records
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="requestForm" action="{% url 'patients:request_medical_records' %}" method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="requestType" class="form-label"><strong>Request Type:</strong></label>
                        <select class="form-select" name="request_type" id="requestType" required>
                            <option value="">Select request type...</option>
                            <option value="records_from_provider">Records from Previous Provider</option>
                            <option value="specialist_records">Specialist/Consultant Records</option>
                            <option value="hospital_records">Hospital/Inpatient Records</option>
                            <option value="imaging_results">Imaging Results (X-ray, MRI, CT)</option>
                            <option value="lab_results">Lab Results from External Lab</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="providerName" class="form-label"><strong>Provider/Facility Name:</strong></label>
                        <input type="text" class="form-control" name="provider_name" id="providerName" required>
                        <small class="form-text text-muted">Name of the healthcare provider or facility</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="providerContact" class="form-label"><strong>Provider Contact Information:</strong></label>
                        <textarea class="form-control" name="provider_contact" id="providerContact" rows="3" placeholder="Address, phone number, fax, email..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="dateRange" class="form-label"><strong>Approximate Date Range:</strong></label>
                        <div class="row">
                            <div class="col-6">
                                <input type="date" class="form-control" name="date_from" placeholder="From date">
                            </div>
                            <div class="col-6">
                                <input type="date" class="form-control" name="date_to" placeholder="To date">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="requestDetails" class="form-label"><strong>Additional Details:</strong></label>
                        <textarea class="form-control" name="details" id="requestDetails" rows="3" placeholder="Specific records needed, reason for request, any additional information..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="urgency" class="form-label"><strong>Urgency:</strong></label>
                        <select class="form-select" name="urgency">
                            <option value="routine">Routine (7-10 business days)</option>
                            <option value="urgent">Urgent (3-5 business days)</option>
                            <option value="emergency">Emergency (24-48 hours)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitRequest()">
                    <i class="fas fa-paper-plane"></i> Submit Request
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Document Upload Modal -->
<div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadModalLabel">
                    <i class="fas fa-upload"></i> Upload Document
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="uploadForm" action="{% url 'patients:upload_document' %}" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="documentName" class="form-label"><strong>Document Name:</strong></label>
                        <input type="text" class="form-control" name="document_name" id="documentName" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="documentType" class="form-label"><strong>Document Type:</strong></label>
                        <select class="form-select" name="document_type" id="documentType" required>
                            <option value="">Select document type...</option>
                            <option value="Insurance">Insurance Card</option>
                            <option value="Medical">Medical Records</option>
                            <option value="Test Results">Test Results</option>
                            <option value="Imaging">Imaging/X-rays</option>
                            <option value="Prescription">Prescription</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="documentFile" class="form-label"><strong>Choose File:</strong></label>
                        <input type="file" class="form-control" name="document_file" id="documentFile" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" required>
                        <small class="form-text text-muted">Accepted formats: PDF, JPG, PNG, DOC, DOCX (Max 10MB)</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="documentDescription" class="form-label"><strong>Description (optional):</strong></label>
                        <textarea class="form-control" name="description" id="documentDescription" rows="3" placeholder="Brief description of the document..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-upload"></i> Upload Document
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Document Details Modal -->
<div class="modal fade" id="documentModal" tabindex="-1" aria-labelledby="documentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="documentModalLabel">
                    <i class="fas fa-file-alt"></i> Document Details
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="documentModalBody">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="downloadFromModal">
                    <i class="fas fa-download"></i> Download
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Handle custom date range display
document.getElementById('dateRange').addEventListener('change', function() {
    const customRange = document.getElementById('customDateRange');
    if (this.value === 'custom') {
        customRange.style.display = 'block';
    } else {
        customRange.style.display = 'none';
    }
});

// Handle export functionality
function exportRecords() {
    const form = document.getElementById('exportForm');
    const formData = new FormData();
    
    // Add CSRF token
    formData.append('csrfmiddlewaretoken', form.querySelector('[name="csrfmiddlewaretoken"]').value);
    
    // Add selected record types
    const checkboxes = form.querySelectorAll('input[type="checkbox"]:checked');
    const recordTypes = Array.from(checkboxes).map(cb => cb.value);
    formData.append('record_types', JSON.stringify(recordTypes));
    
    // Add other form data
    formData.append('date_range', form.querySelector('[name="date_range"]').value);
    formData.append('format', form.querySelector('[name="format"]').value);
    
    if (form.querySelector('[name="date_range"]').value === 'custom') {
        formData.append('start_date', form.querySelector('[name="start_date"]').value);
        formData.append('end_date', form.querySelector('[name="end_date"]').value);
    }
    
    // Show loading state
    const exportBtn = document.querySelector('#exportModal .btn-primary');
    const originalText = exportBtn.innerHTML;
    exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
    exportBtn.disabled = true;
    
    // Submit form
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            return response.blob();
        }
        throw new Error('Export failed');
    })
    .then(blob => {
        // Create download link
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        
        // Set filename based on format
        const format = form.querySelector('[name="format"]').value;
        const extension = format === 'pdf' ? 'pdf' : format === 'excel' ? 'xlsx' : 'csv';
        a.download = `medical_records_${new Date().toISOString().split('T')[0]}.${extension}`;
        
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('exportModal')).hide();
    })
    .catch(error => {
        alert('Export failed. Please try again.');
        console.error('Export error:', error);
    })
    .finally(() => {
        // Restore button state
        exportBtn.innerHTML = originalText;
        exportBtn.disabled = false;
    });
}

// Handle request submission
function submitRequest() {
    const form = document.getElementById('requestForm');
    const formData = new FormData(form);
    
    // Show loading state
    const submitBtn = document.querySelector('#requestModal .btn-primary');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
    submitBtn.disabled = true;
    
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            return response.json();
        }
        throw new Error('Request failed');
    })
    .then(data => {
        alert('Request submitted successfully! You will be contacted within the specified timeframe.');
        bootstrap.Modal.getInstance(document.getElementById('requestModal')).hide();
        form.reset();
    })
    .catch(error => {
        alert('Request submission failed. Please try again.');
        console.error('Request error:', error);
    })
    .finally(() => {
        // Restore button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// Tab-specific functionality
function viewAppointmentDetails(appointmentId) {
    // Get appointment data and show in modal
    fetch(`/patients/appointments/${appointmentId}/details/`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAppointmentModal(data.appointment);
            } else {
                alert('Failed to load appointment details.');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading appointment details.');
        });
}

function showAppointmentModal(appointment) {
    const modalHtml = `
        <div class="modal fade" id="appointmentDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-calendar-check"></i> Appointment Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><strong>Appointment Information</strong></h6>
                                <p><strong>Date:</strong> ${appointment.date}</p>
                                <p><strong>Time:</strong> ${appointment.time}</p>
                                <p><strong>Doctor:</strong> Dr. ${appointment.doctor}</p>
                                <p><strong>Status:</strong> <span class="badge bg-success">${appointment.status}</span></p>
                                <p><strong>Type:</strong> ${appointment.type}</p>
                            </div>
                            <div class="col-md-6">
                                <h6><strong>Medical Details</strong></h6>
                                <p><strong>Chief Complaint:</strong> ${appointment.complaint || 'N/A'}</p>
                                <p><strong>Diagnosis:</strong> ${appointment.diagnosis || 'N/A'}</p>
                                <p><strong>Prescription:</strong> ${appointment.prescription || 'None'}</p>
                                <p><strong>Notes:</strong> ${appointment.notes || 'No additional notes'}</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('appointmentDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body and show
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('appointmentDetailsModal'));
    modal.show();
}

function viewLabDetails(testName, testDate) {
    // Find the lab result data
    const labResults = {{ lab_results_json|safe }};
    const labResult = labResults.find(result => result.test_name === testName && result.date === testDate);
    
    if (labResult) {
        showLabDetailsModal(labResult);
    } else {
        alert('Lab result details not found.');
    }
}

function showLabDetailsModal(labResult) {
    const detailsHtml = Object.entries(labResult.details).map(([key, value]) => 
        `<p><strong>${key}:</strong> ${value}</p>`
    ).join('');
    
    const modalHtml = `
        <div class="modal fade" id="labDetailsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-flask"></i> Lab Test Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><strong>Test Information</strong></h6>
                                <p><strong>Test Name:</strong> ${labResult.test_name}</p>
                                <p><strong>Date:</strong> ${labResult.date}</p>
                                <p><strong>Lab:</strong> ${labResult.lab}</p>
                                <p><strong>Status:</strong> <span class="badge bg-success">${labResult.status}</span></p>
                                <p><strong>Ordered by:</strong> ${labResult.ordered_by}</p>
                            </div>
                            <div class="col-md-6">
                                <h6><strong>Results Summary</strong></h6>
                                <p><strong>Overall Result:</strong> ${labResult.results}</p>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-12">
                                <h6><strong>Detailed Results</strong></h6>
                                ${detailsHtml}
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="downloadLabReport('${labResult.test_name}', '${labResult.date}')">
                            <i class="fas fa-download"></i> Download Report
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('labDetailsModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body and show
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('labDetailsModal'));
    modal.show();
}

function downloadLabReport(testName, testDate) {
    // Create a download for lab report
    alert(`Downloading ${testName} report from ${testDate}. This would typically generate a PDF report.`);
    // In a real implementation, this would trigger a download
}

function requestRefill(medication) {
    // Show refill request modal
    const modalHtml = `
        <div class="modal fade" id="refillModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-pills"></i> Request Refill</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Medication:</strong> ${medication}</p>
                        <div class="mb-3">
                            <label for="refillReason" class="form-label">Reason for refill request:</label>
                            <textarea class="form-control" id="refillReason" rows="3" placeholder="Please provide any additional information..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="pharmacyInfo" class="form-label">Preferred Pharmacy:</label>
                            <input type="text" class="form-control" id="pharmacyInfo" placeholder="Pharmacy name and location">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-warning" onclick="submitRefillRequest('${medication}')">
                            <i class="fas fa-paper-plane"></i> Submit Request
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('refillModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body and show
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('refillModal'));
    modal.show();
}

function submitRefillRequest(medication) {
    const reason = document.getElementById('refillReason').value;
    const pharmacy = document.getElementById('pharmacyInfo').value;
    
    // In a real implementation, this would send the request to the backend
    alert(`Refill request submitted for ${medication}.\nReason: ${reason}\nPharmacy: ${pharmacy}\n\nYour doctor will be notified.`);
    bootstrap.Modal.getInstance(document.getElementById('refillModal')).hide();
}

function contactDoctor(medication) {
    // Show contact doctor modal
    const modalHtml = `
        <div class="modal fade" id="contactDoctorModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-user-md"></i> Contact Doctor</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Regarding:</strong> ${medication}</p>
                        <div class="mb-3">
                            <label for="messageSubject" class="form-label">Subject:</label>
                            <select class="form-control" id="messageSubject">
                                <option>Prescription Renewal</option>
                                <option>Side Effects</option>
                                <option>Dosage Questions</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="messageText" class="form-label">Message:</label>
                            <textarea class="form-control" id="messageText" rows="4" placeholder="Please describe your question or concern..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="urgencyLevel" class="form-label">Urgency:</label>
                            <select class="form-control" id="urgencyLevel">
                                <option>Routine</option>
                                <option>Urgent</option>
                                <option>Emergency</option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="sendDoctorMessage('${medication}')">
                            <i class="fas fa-paper-plane"></i> Send Message
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('contactDoctorModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body and show
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('contactDoctorModal'));
    modal.show();
}

function sendDoctorMessage(medication) {
    const subject = document.getElementById('messageSubject').value;
    const message = document.getElementById('messageText').value;
    const urgency = document.getElementById('urgencyLevel').value;
    
    // In a real implementation, this would send the message to the doctor
    alert(`Message sent to your doctor.\nSubject: ${subject}\nUrgency: ${urgency}\nMessage: ${message}\n\nYou will receive a response within 24 hours.`);
    bootstrap.Modal.getInstance(document.getElementById('contactDoctorModal')).hide();
}

function viewPrescriptionDetails(medication) {
    // Find the prescription data
    const prescriptions = {{ prescriptions_json|safe }};
    const prescription = prescriptions.find(rx => rx.medication === medication);
    
    if (prescription) {
        showPrescriptionModal(prescription);
    } else {
        alert('Prescription details not found.');
    }
}

function showPrescriptionModal(prescription) {
    const modalHtml = `
        <div class="modal fade" id="prescriptionModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-prescription"></i> Prescription Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-12">
                                <h6><strong>Medication Information</strong></h6>
                                <p><strong>Medication:</strong> ${prescription.medication}</p>
                                <p><strong>Dosage:</strong> ${prescription.dosage}</p>
                                <p><strong>Frequency:</strong> ${prescription.frequency}</p>
                                <p><strong>Prescribed Date:</strong> ${prescription.prescribed_date}</p>
                                <p><strong>Doctor:</strong> ${prescription.doctor}</p>
                                <p><strong>Status:</strong> <span class="badge bg-${prescription.status === 'Active' ? 'success' : 'secondary'}">${prescription.status}</span></p>
                                <p><strong>Refills Remaining:</strong> ${prescription.refills}</p>
                                <hr>
                                <h6><strong>Instructions</strong></h6>
                                <p>${prescription.instructions}</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        ${prescription.status === 'Active' && prescription.refills > 0 ? 
                            `<button type="button" class="btn btn-warning" onclick="requestRefill('${prescription.medication}')">
                                <i class="fas fa-redo"></i> Request Refill
                            </button>` : ''}
                        <button type="button" class="btn btn-primary" onclick="contactDoctor('${prescription.medication}')">
                            <i class="fas fa-user-md"></i> Contact Doctor
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('prescriptionModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body and show
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('prescriptionModal'));
    modal.show();
}

// Visit History Functions
function viewVisitDetails(visitDate, doctorName) {
    // Find the medical record for this visit
    const medicalRecords = {{ medical_records_json|safe }};
    const record = medicalRecords.find(r => r.date === visitDate && r.doctor === doctorName);
    
    if (record) {
        showVisitDetailsModal(record);
    } else {
        showToast('Visit details not found', 'error');
    }
}

function showVisitDetailsModal(record) {
    const modalHtml = `
        <div class="modal fade" id="visitModal" tabindex="-1" aria-labelledby="visitModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="visitModalLabel">
                            <i class="fas fa-calendar-check"></i> Visit Details - ${record.date}
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-user-md"></i> Doctor Information</h6>
                                <p><strong>Doctor:</strong> ${record.doctor}</p>
                                <p><strong>Visit Type:</strong> ${record.type}</p>
                                <p><strong>Date:</strong> ${new Date(record.date).toLocaleDateString()}</p>
                            </div>
                            <div class="col-md-6">
                                <h6><i class="fas fa-heartbeat"></i> Vital Signs</h6>
                                <p>${record.vitals}</p>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6><i class="fas fa-stethoscope"></i> Diagnosis</h6>
                                <p class="alert alert-info">${record.diagnosis}</p>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6><i class="fas fa-notes-medical"></i> Visit Notes</h6>
                                <p>${record.notes}</p>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" onclick="printVisit('${record.date}')">
                            <i class="fas fa-print"></i> Print Visit
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if present
    const existingModal = document.getElementById('visitModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('visitModal'));
    modal.show();
}

function printVisit(visitDate) {
    showToast(`Preparing to print visit details for ${visitDate}`, 'info');
    // In a real application, this would generate and print a visit summary
}

// Test function to verify JavaScript is working
function testDocumentButtons() {
    console.log('Document button test function is working');
    showToast('JavaScript is working correctly!', 'success');
    
    const documents = {{ documents_json|safe }};
    console.log('Available documents for testing:', documents);
    
    if (documents.length > 0) {
        console.log('First document:', documents[0]);
        showToast(`Found ${documents.length} documents. First document: ${documents[0].name}`, 'info');
    }
}

// Test on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Medical records page loaded');
    console.log('Available documents:', {{ documents_json|safe }});
});

// Utility function to show toast notifications
function showToast(message, type = 'info') {
    const toastContainer = document.createElement('div');
    toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
    
    const bgClass = type === 'success' ? 'bg-success' : 
                   type === 'error' ? 'bg-danger' : 
                   type === 'warning' ? 'bg-warning' : 'bg-primary';
    
    toastContainer.innerHTML = `
        <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header ${bgClass} text-white">
                <i class="fas ${type === 'success' ? 'fa-check' : type === 'error' ? 'fa-times' : type === 'warning' ? 'fa-exclamation' : 'fa-info'} me-2"></i>
                <strong class="me-auto">${type === 'success' ? 'Success' : type === 'error' ? 'Error' : type === 'warning' ? 'Warning' : 'Info'}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    document.body.appendChild(toastContainer);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (document.body.contains(toastContainer)) {
            document.body.removeChild(toastContainer);
        }
    }, 5000);
}

function viewDocument(documentName) {
    try {
        console.log('Viewing document:', documentName);
        
        // Find the document data
        const documents = {{ documents_json|safe }};
        console.log('Available documents:', documents);
        
        const documentData = documents.find(doc => doc.name === documentName);
        
        if (documentData) {
            console.log('Found document:', documentData);
            showDocumentModal(documentData);
        } else {
            console.error('Document not found:', documentName);
            showToast('Document not found: ' + documentName, 'error');
        }
    } catch (error) {
        console.error('Error in viewDocument:', error);
        showToast('Error viewing document: ' + error.message, 'error');
    }
}

function showDocumentModal(documentData) {
    const modalHtml = `
        <div class="modal fade" id="documentModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-file-alt"></i> Document Details</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><strong>Document Information</strong></h6>
                                <p><strong>Name:</strong> ${documentData.name}</p>
                                <p><strong>Type:</strong> ${documentData.type}</p>
                                <p><strong>Format:</strong> ${documentData.format}</p>
                                <p><strong>Size:</strong> ${documentData.size}</p>
                                <p><strong>Upload Date:</strong> ${documentData.date_uploaded}</p>
                            </div>
                            <div class="col-md-6">
                                <div class="text-center">
                                    ${documentData.format === 'PDF' ? '<i class="fas fa-file-pdf fa-5x text-danger"></i>' :
                                      documentData.type === 'Imaging' ? '<i class="fas fa-x-ray fa-5x text-info"></i>' :
                                      '<i class="fas fa-file-alt fa-5x text-primary"></i>'}
                                    <h6 class="mt-3">${documentData.name}</h6>
                                </div>
                            </div>
                        </div>
                        <hr>
                        <div class="text-center">
                            <p class="text-muted">Document preview would appear here in a real implementation</p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" onclick="downloadDocument('${documentData.name}')">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button type="button" class="btn btn-info" onclick="shareDocument('${documentData.name}')">
                            <i class="fas fa-share"></i> Share
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('documentModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body and show
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('documentModal'));
    modal.show();
}

function downloadDocument(documentName) {
    try {
        console.log('Downloading document:', documentName);
        
        // Show loading message
        showToast('Starting download...', 'info');
        
        // Use direct link approach for better compatibility
        const downloadUrl = `{% url "patients:download_document" "PLACEHOLDER" %}`.replace('PLACEHOLDER', encodeURIComponent(documentName));
        
        // Create temporary link element
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = documentName + '.pdf';
        link.target = '_blank';
        
        // Add to DOM, click, and remove
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Show success message after short delay
        setTimeout(() => {
            showToast('Download started successfully!', 'success');
        }, 500);
        
    } catch (error) {
        console.error('Download error:', error);
        showToast('Download failed: ' + error.message, 'error');
    }
}

function shareDocument(documentName) {
    showToast(`Sharing functionality for "${documentName}" is not yet implemented. This would allow you to share documents with healthcare providers.`, 'info');
}

function uploadDocument() {
    // Show upload modal
    const modalHtml = `
        <div class="modal fade" id="uploadModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title"><i class="fas fa-upload"></i> Upload Document</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="uploadForm" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="documentFile" class="form-label">Select File:</label>
                                <input type="file" class="form-control" id="documentFile" accept=".pdf,.jpg,.png,.doc,.docx" required>
                                <small class="form-text text-muted">Accepted formats: PDF, JPG, PNG, DOC, DOCX (Max 10MB)</small>
                            </div>
                            <div class="mb-3">
                                <label for="documentType" class="form-label">Document Type:</label>
                                <select class="form-control" id="documentType" required>
                                    <option value="">Select type...</option>
                                    <option value="Medical">Medical Records</option>
                                    <option value="Insurance">Insurance Documents</option>
                                    <option value="Test Results">Test Results</option>
                                    <option value="Imaging">Imaging/X-rays</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="documentDescription" class="form-label">Description (optional):</label>
                                <textarea class="form-control" id="documentDescription" rows="2" placeholder="Brief description of the document..."></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="submitUpload()">
                            <i class="fas fa-upload"></i> Upload Document
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('uploadModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body and show
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('uploadModal'));
    modal.show();
}

function submitUpload() {
    const fileInput = document.getElementById('documentFile');
    const typeSelect = document.getElementById('documentType');
    const descriptionText = document.getElementById('documentDescription');
    
    if (!fileInput.files[0]) {
        showToast('Please select a file to upload.', 'warning');
        return;
    }
    
    if (!typeSelect.value) {
        showToast('Please select a document type.', 'warning');
        return;
    }
    
    // Create form data for file upload
    const formData = new FormData();
    formData.append('document_file', fileInput.files[0]);
    formData.append('document_type', typeSelect.value);
    formData.append('description', descriptionText.value || '');
    
    // Add CSRF token
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    // Upload file
    fetch('{% url "patients:upload_document" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('Document uploaded successfully!', 'success');
            // Close modal and refresh the page to show new document
            bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            showToast(data.error || 'Upload failed. Please try again.', 'error');
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        showToast('Upload failed. Please check your connection and try again.', 'error');
    });
}
</script>
{% endblock %}